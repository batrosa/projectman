rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Функция: Проверка, что пользователь Админ
    function isAdmin() {
      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Функция: Проверка, что пользователь не меняет защищенные поля (роль и доступы)
    function notUpdatingRestrictedFields() {
      return (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'allowedProjects']));
    }

    // Функция: Проверка прав на проект
    function canViewProject(projectId) {
      let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return userData.allowedProjects == null || userData.allowedProjects.size() == 0 || projectId in userData.allowedProjects;
    }

    // Коллекция Users
    match /users/{userId} {
      // Читать могут все авторизованные (нужно для списков assignee), 
      // но лучше ограничить: каждый себя или Админ всех. 
      // Для простоты пока оставим: Админ или владелец.
      // (ВАЖНО: Для выпадающего списка "assignee" нам нужно, чтобы пользователи могли видеть список коллег.
      // Поэтому разрешим читать список пользователей всем авторизованным)
      allow read: if request.auth != null;
      
      // Создавать профиль может только сам пользователь при регистрации (и роль должна быть 'reader' или отсутствовать)
      allow create: if request.auth != null && request.auth.uid == userId 
        && (!request.resource.data.keys().hasAll(['role']) || request.resource.data.role == 'reader');
      
      // Обновлять: Владелец (но БЕЗ смены роли) ИЛИ Админ (все поля)
      allow update: if (request.auth != null && request.auth.uid == userId && notUpdatingRestrictedFields()) 
                    || isAdmin();
      
      // Удалять: Только Админ
      allow delete: if isAdmin();
    }

    // Коллекция Projects
    match /projects/{projectId} {
      allow read: if isAdmin() || (request.auth != null && canViewProject(projectId));
      allow write: if isAdmin(); // Создание/Редактирование/Удаление только Админ
    }

    // Коллекция Tasks
    match /tasks/{taskId} {
      // Чтение: Админ или если есть доступ к проекту (тут сложно проверить проект без лишнего get, 
      // но мы проверим через поле projectId в самой задаче)
      allow read: if isAdmin() || (request.auth != null && canViewProject(resource.data.projectId));
      
      // Запись: 
      // 1. Админ может всё.
      // 2. Обычный пользователь (Reader) может только ОБНОВЛЯТЬ статус задачи (drag & drop) 
      // и ставить галочку "assigneeCompleted", но НЕ менять название/дедлайн/удалять.
      allow create, delete: if isAdmin();
      allow update: if isAdmin() 
        || (request.auth != null 
            && canViewProject(resource.data.projectId) 
            && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'assigneeCompleted', 'reminderSent', 'subStatus', 'attachments']));
    }

    // Коллекция Events (События)
    match /events/{eventId} {
      // Читать: авторизованный пользователь, который является участником
      allow read: if request.auth != null
        && (request.auth.uid in resource.data.participantIds);

      // Создать: авторизованный пользователь, который является участником
      allow create: if request.auth != null
        && (request.auth.uid in request.resource.data.participantIds);

      // Обновить: создатель может всё; участники могут обновлять только reminder флаги
      allow update: if request.auth != null
        && (
          request.auth.uid == resource.data.createdById
          || (
            (request.auth.uid in resource.data.participantIds)
            && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reminder2hSent', 'reminder2hSentAt'])
          )
        );

      // Удалить: только создатель
      allow delete: if request.auth != null
        && request.auth.uid == resource.data.createdById;
    }

    // Коллекция telegramCodes - временные коды для подключения Telegram
    match /telegramCodes/{code} {
      // Пользователь может создать код для себя
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      // Чтение и удаление - для серверных функций (через API key)
      allow read, delete: if true;
    }
  }
}
