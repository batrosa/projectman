<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Prevent HTML caching - always fetch fresh version -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>ProjectMan</title>

    <!-- Preload critical CSS -->
    <link rel="preload" href="style.css?v=4.9" as="style">
    <link rel="stylesheet" href="style.css?v=4.9">
    <link rel="stylesheet" href="mobile-additions.css?v=4.9">

    <!-- Preconnect to external resources for faster loading -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.gstatic.com">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">

    <!-- Async load fonts - non-blocking -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"
        media="print" onload="this.media='all'">

    <!-- Async load icons - non-blocking -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        media="print" onload="this.media='all'">

    <!-- Inline critical CSS for loading indicator -->
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f172a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.3s;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(99, 102, 241, 0.3);
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: rgba(255, 255, 255, 0.7);
            margin-top: 1rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 14px;
        }
    </style>

    <!-- Version checker - ОТКЛЮЧЕН временно для отладки -->
    <!-- <script src="version-check.js?v=1.9" defer></script> -->

    <!-- Scripts with defer for non-blocking loading -->
    <!-- Local Firebase Libraries for offline support and region independence -->
    <script src="libs/firebase-app.js" defer></script>
    <script src="libs/firebase-firestore.js" defer></script>
    <script src="libs/firebase-auth.js" defer></script>
    <!-- EmailJS загружается последним - он не критичен -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js" defer></script>
    <script src="script.js?v=4.9" defer></script>
</head>

<body>
    <!-- Loading Overlay with progress text -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">Загрузка приложения...</div>
    </div>

    <!-- Auth Overlay -->
    <div id="auth-overlay" class="login-overlay">
        <!-- Registration/Login Screen -->
        <div id="auth-screen" class="login-card">
            <div class="brand" style="justify-content: center; margin-bottom: 1.5rem;">
                <i class="fa-solid fa-layer-group"></i> ProjectMan
            </div>
            <h2 id="auth-title">Вход в систему</h2>
            <p id="auth-subtitle" style="color: var(--text-secondary); margin-bottom: 2rem; text-align: center;">
                Войдите или зарегистрируйтесь
            </p>

            <!-- Login Form -->
            <form id="login-form" style="display: block; width: 100%;">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label for="login-password">Пароль</label>
                    <input type="password" id="login-password" required placeholder="Введите пароль">
                </div>
                <p id="login-error"
                    style="color: var(--danger); font-size: 0.85rem; margin-bottom: 1rem; display: none; text-align: left;">
                </p>
                <button type="submit" class="primary-btn"
                    style="width: 100%; justify-content: center; margin-bottom: 1rem;">Войти</button>
                <p style="text-align: center; font-size: 0.9rem; color: var(--text-secondary);">
                    Нет аккаунта? <a href="#" id="show-register"
                        style="color: var(--primary); text-decoration: none; font-weight: 500;">Зарегистрироваться</a>
                </p>
            </form>

            <!-- Registration Form -->
            <form id="register-form" style="display: none; width: 100%;">
                <div class="form-row" style="gap: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <label for="register-first-name">Имя</label>
                        <input type="text" id="register-first-name" required placeholder="Иван">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="register-last-name">Фамилия</label>
                        <input type="text" id="register-last-name" required placeholder="Иванов">
                    </div>
                </div>
                <div class="form-group">
                    <label for="register-email">Email</label>
                    <input type="email" id="register-email" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label for="register-password">Пароль</label>
                    <input type="password" id="register-password" required placeholder="Минимум 6 символов">
                </div>
                <div class="form-group">
                    <label for="register-password-confirm">Подтвердите пароль</label>
                    <input type="password" id="register-password-confirm" required placeholder="Повторите пароль">
                </div>
                <p id="register-error"
                    style="color: var(--danger); font-size: 0.85rem; margin-bottom: 1rem; display: none; text-align: left;">
                </p>
                <button type="submit" class="primary-btn"
                    style="width: 100%; justify-content: center; margin-bottom: 1rem;">Зарегистрироваться</button>
                <p style="text-align: center; font-size: 0.9rem; color: var(--text-secondary);">
                    Уже есть аккаунт? <a href="#" id="show-login"
                        style="color: var(--primary); text-decoration: none; font-weight: 500;">Войти</a>
                </p>
            </form>
        </div>

        <!-- Role Selection Screen (Removed) -->
        
        <!-- Admin Password Verification Modal -->
        <div id="admin-verify-screen" class="login-card" style="display: none;">
            <div class="brand" style="justify-content: center; margin-bottom: 2rem;">
                <i class="fa-solid fa-shield-halved"></i>
            </div>
            <h2>Подтверждение администратора</h2>
            <p style="color: var(--text-secondary); margin-bottom: 2rem; text-align: center;">Введите пароль
                администратора</p>

            <div class="form-group">
                <label for="admin-verify-password">Пароль администратора</label>
                <input type="password" id="admin-verify-password" placeholder="Введите пароль"
                    style="margin-bottom: 1rem;">
            </div>
            <p id="admin-verify-error"
                style="color: var(--danger); font-size: 0.8rem; margin-bottom: 1rem; display: none;">Неверный пароль</p>
            <div style="display: flex; gap: 1rem;">
                <button id="admin-verify-cancel" class="secondary-btn"
                    style="flex: 1; justify-content: center;">Отмена</button>
                <button id="admin-verify-submit" class="primary-btn"
                    style="flex: 1; justify-content: center;">Подтвердить</button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <aside class="sidebar">
            <div class="brand">
                <i class="fa-solid fa-layer-group"></i> ProjectMan
            </div>

            <div class="projects-header">
                <h3>ПРОЕКТЫ</h3>
                <button id="add-project-btn" class="icon-btn" title="Создать проект">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <ul id="project-list" class="project-list">
                <!-- Projects will be injected here -->
            </ul>

            <div class="sidebar-footer"
                style="margin-top: auto; padding-top: 1rem; display: flex; flex-direction: column; gap: 0.5rem;">
                <button id="my-tasks-btn" class="my-tasks-btn" style="width: 100%; justify-content: center;">
                    <i class="fa-solid fa-list-check"></i> <span>Мои задачи</span>
                    <span id="my-tasks-count" class="my-tasks-count" style="display: none;">0</span>
                </button>
                <button id="admin-panel-btn" class="secondary-btn"
                    style="width: 100%; justify-content: center; display: none;">
                    <i class="fa-solid fa-user-shield"></i> <span>Админ панель</span>
                </button>
                <button id="theme-toggle" class="secondary-btn" style="width: 100%; justify-content: center;">
                    <i class="fa-regular fa-sun"></i> <span>Светлая тема</span>
                </button>
                <button id="logout-btn" class="danger-btn"
                    style="width: 100%; justify-content: center; background: rgba(239, 68, 68, 0.05);">
                    <i class="fa-solid fa-right-from-bracket"></i> <span>Выйти</span>
                </button>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <button id="mobile-menu-btn" class="icon-btn" style="margin-right: 1rem; font-size: 1.2rem;">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <div class="project-info" id="active-project-info">
                    <h1 id="project-title">Выберите бизнес</h1>
                    <p id="project-desc">или создайте новый, чтобы начать работу</p>
                </div>
                <div class="actions">
                    <button id="help-btn" class="secondary-btn" title="Помощь">
                        <i class="fa-solid fa-circle-question"></i>
                    </button>
                    <button id="add-task-btn" class="primary-btn" disabled>
                        <i class="fa-solid fa-plus"></i> Новая задача
                    </button>
                    <button id="delete-project-btn" class="danger-btn" style="display: none;">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </header>

            <div class="board-container" id="board-container">
                <!-- Kanban Columns -->
                <!-- Kanban Columns -->

                <div class="column" data-status="in-progress">
                    <div class="column-header">
                        <span class="status-indicator in-progress"></span>
                        <h2>В процессе</h2>
                        <span class="count" id="count-in-progress">0</span>
                    </div>
                    <div class="task-list" id="list-in-progress">
                        <!-- Tasks -->
                    </div>
                </div>

                <div class="column" data-status="done">
                    <div class="column-header">
                        <span class="status-indicator done"></span>
                        <h2>Готово</h2>
                        <span class="count" id="count-done">0</span>
                    </div>
                    <div class="task-list" id="list-done">
                        <!-- Tasks -->
                    </div>
                </div>
            </div>

            <div id="empty-state" class="empty-state">
                <i class="fa-solid fa-clipboard-list"></i>
                <p>Выберите бизнес слева, чтобы увидеть задачи</p>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="project-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Новый проект</h2>
                <button class="close-modal"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <form id="project-form">
                <div class="form-group">
                    <label for="p-name">Название</label>
                    <input type="text" id="p-name" required placeholder="">
                </div>
                <div class="form-group">
                    <label for="p-desc">Описание деятельности</label>
                    <textarea id="p-desc" rows="3" placeholder="Краткое описание..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="secondary-btn close-modal">Отмена</button>
                    <button type="submit" class="primary-btn">Создать</button>
                </div>
            </form>
        </div>
    </div>

    <div id="task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Новая задача</h2>
                <button class="close-modal"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <form id="task-form">
                <div class="form-group">
                    <label for="t-title">Задача</label>
                    <input type="text" id="t-title" required placeholder="Что нужно сделать?">
                </div>

                <div class="form-group">
                    <label for="t-description">Комментарий / Описание</label>
                    <textarea id="t-description" rows="3" placeholder="Подробности задачи..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Ответственные</label>
                        <div id="t-assignee-container" class="multi-select-container">
                            <!-- Checkboxes will be injected here -->
                            <div style="padding: 0.5rem; color: var(--text-secondary);">Загрузка...</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="t-deadline">Срок</label>
                        <input type="date" id="t-deadline" required>
                    </div>
                </div>

                <!-- File Attachments Section -->
                <div class="form-group">
                    <label><i class="fa-solid fa-paperclip"></i> Прикрепленные файлы (макс. 2)</label>
                    <div id="attachments-container" class="attachments-container">
                        <div id="attachments-list" class="attachments-list">
                            <!-- Attached files will appear here -->
                        </div>
                        <button type="button" id="add-attachment-btn" class="add-attachment-btn">
                            <i class="fa-solid fa-plus"></i> Прикрепить файл
                        </button>
                        <input type="file" id="file-input" style="display: none;" 
                               accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.zip,.rar">
                        <p class="attachment-hint">PDF, Word, Excel, изображения, архивы. Макс. 10 MB</p>
                    </div>
                </div>

                <!-- Status hidden, defaults to in-progress -->
                <input type="hidden" id="t-status" value="in-progress">
                <input type="hidden" id="t-id">
                <div class="modal-footer">
                    <button type="button" class="secondary-btn close-modal">Отмена</button>
                    <button type="submit" class="primary-btn">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal">
        <div class="modal-content help-modal-content">
            <div class="modal-header">
                <h2><i class="fa-solid fa-circle-question"></i> Помощь</h2>
                <button class="close-modal"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="help-content">
                <div class="help-section">
                    <h3><i class="fa-solid fa-rocket"></i> О системе</h3>
                    <p>ProjectMan - система управления задачами с двойным контролем.</p>
                    <ul>
                        <li><strong>Проекты:</strong> Выбирайте проекты в меню слева (на ПК) или через кнопку <i class="fa-solid fa-bars"></i> (на мобильном).</li>
                        <li><strong>Задачи:</strong> Админ создает задачи и назначает исполнителей.</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3><i class="fa-solid fa-users"></i> Роли</h3>
                    <p><strong>Администратор:</strong></p>
                    <ul>
                        <li>Полный доступ (создание, удаление, редактирование).</li>
                        <li>Управление пользователями.</li>
                        <li>Финальное подтверждение задач (Левая галочка).</li>
                    </ul>
                    <p><strong>Исполнитель (Сотрудник):</strong></p>
                    <ul>
                        <li>Видит доступные проекты.</li>
                        <li>Отмечает выполнение своих задач (Правая галочка).</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3><i class="fa-solid fa-list-check"></i> Статусы задач</h3>
                    <p>Теперь вместо галочек используются статусы:</p>
                    <ul style="list-style: none; padding-left: 0;">
                        <li style="margin-bottom: 0.5rem;">
                            <span style="color: #e67e22; font-weight: bold;"><i class="fa-solid fa-circle-exclamation"></i> Задача поставлена:</span>
                            Новая задача от Админа.
                        </li>
                        <li style="margin-bottom: 0.5rem;">
                            <span style="color: #f39c12; font-weight: bold;"><i class="fa-solid fa-person-digging"></i> В работе:</span>
                            Сотрудник принял задачу.
                        </li>
                        <li style="margin-bottom: 0.5rem;">
                            <span style="color: #2ecc71; font-weight: bold;"><i class="fa-solid fa-check"></i> Задача завершена:</span>
                            Сотрудник выполнил работу.
                        </li>
                        <li>
                            <span style="color: #2ecc71; font-weight: bold;"><i class="fa-solid fa-check-double"></i> Готово (Архив):</span>
                            Админ подтвердил выполнение.
                        </li>
                    </ul>
                    <div class="help-note">
                        <i class="fa-solid fa-info-circle"></i> Нажмите на статус задачи, чтобы изменить его (например, "Принять в работу").
                    </div>
                </div>

                <div class="help-section">
                    <h3><i class="fa-solid fa-mobile-screen"></i> Мобильная версия</h3>
                    <p>Приложение адаптировано для смартфонов:</p>
                    <ul>
                        <li><strong>Меню:</strong> Нажмите кнопку <i class="fa-solid fa-bars"></i> в левом верхнем углу для выбора проекта.</li>
                        <li><strong>Навигация:</strong> Листайте список задач вверх-вниз.</li>
                        <li><strong>Удобство:</strong> Кнопки выполнения увеличены для удобного нажатия пальцем.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- File Preview Modal -->
    <div id="file-preview-modal" class="modal">
        <div class="modal-content file-preview-content">
            <div class="modal-header">
                <h2><i class="fa-solid fa-file"></i> <span id="preview-file-name">Файл</span></h2>
                <div style="display: flex; gap: 0.5rem;">
                    <a id="preview-download-btn" href="#" download class="secondary-btn" style="padding: 0.5rem 1rem;">
                        <i class="fa-solid fa-download"></i>
                    </a>
                    <button class="close-modal"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>
            <div id="file-preview-container" class="file-preview-container">
                <!-- Preview content will be injected here -->
                <div class="preview-loading">
                    <div class="spinner"></div>
                    <p>Загрузка файла...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Files List Modal (for task card) -->
    <div id="files-list-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fa-solid fa-paperclip"></i> Прикрепленные файлы</h2>
                <button class="close-modal"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="files-modal-list" class="files-modal-list">
                <!-- Files will be listed here -->
            </div>
        </div>
    </div>

    <!-- My Tasks Modal -->
    <div id="my-tasks-modal" class="modal">
        <div class="modal-content my-tasks-modal-content">
            <div class="modal-header">
                <h2><i class="fa-solid fa-list-check"></i> Мои задачи</h2>
                <button class="close-modal"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="my-tasks-content">
                <div id="my-tasks-list" class="my-tasks-list">
                    <!-- User's tasks will be loaded here -->
                    <div class="my-tasks-empty">
                        <i class="fa-solid fa-clipboard-check"></i>
                        <p>У вас нет назначенных задач</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="admin-panel-modal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2><i class="fa-solid fa-user-shield"></i> Админ панель</h2>
                <button class="close-modal"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="admin-panel-content" style="padding: 1.5rem;">
                <div class="admin-tabs">
                    <button class="admin-tab active" data-tab="users">
                        <i class="fa-solid fa-users"></i> Пользователи
                    </button>
                    <button class="admin-tab" data-tab="access">
                        <i class="fa-solid fa-key"></i> Доступ к проектам
                    </button>
                </div>

                <!-- Users Tab -->
                <div id="admin-users-tab" class="admin-tab-content active">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0;">Зарегистрированные пользователи</h3>
                        <span id="users-count" style="color: var(--text-secondary); font-size: 0.9rem;">0
                            пользователей</span>
                    </div>
                    <div id="users-list" class="users-list">
                        <!-- Users will be loaded here -->
                    </div>
                </div>

                <!-- Project Access Tab -->
                <div id="admin-access-tab" class="admin-tab-content">
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="margin-bottom: 0.5rem;">Управление доступом к проектам</h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">
                            Выберите пользователя и настройте, какие проекты он может видеть
                        </p>
                    </div>

                    <div class="form-group">
                        <label for="access-user-select">Пользователь</label>
                        <select id="access-user-select"
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary); color: var(--text); font-size: 0.95rem;">
                            <option value="">Выберите пользователя...</option>
                        </select>
                    </div>

                    <div id="user-access-info" style="display: none;">
                        <div
                            style="background: var(--bg-secondary); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div class="avatar" style="width: 48px; height: 48px; font-size: 1.2rem;"
                                    id="selected-user-avatar">AB</div>
                                <div>
                                    <h4 id="selected-user-name" style="margin: 0;">Имя Фамилия</h4>
                                    <p id="selected-user-email"
                                        style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">
                                        email@example.com</p>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                <input type="checkbox" id="allow-all-projects" style="width: auto;">
                                <span>Доступ ко всем проектам</span>
                            </label>
                        </div>

                        <div id="project-selection" style="display: block;">
                            <label style="margin-bottom: 0.75rem; display: block; font-weight: 500;">Доступные
                                проекты:</label>
                            <div id="projects-checkboxes" class="projects-checkboxes">
                                <!-- Project checkboxes will be loaded here -->
                            </div>
                        </div>

                        <button id="save-access-btn" class="primary-btn"
                            style="width: 100%; justify-content: center; margin-top: 1.5rem;">
                            <i class="fa-solid fa-save"></i> Сохранить настройки доступа
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inline Safety Script -->
    <script>
        // Failsafe: if the app doesn't load within 8 seconds, show error
        setTimeout(function () {
            var loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay && !loadingOverlay.classList.contains('hidden')) {
                // Only show if no other error is displayed
                if (!loadingOverlay.innerHTML.includes('Ошибка')) {
                    loadingOverlay.innerHTML = '<div style="color:white; text-align:center; font-family:sans-serif; padding:20px;">' +
                        '<h3>Долгая загрузка...</h3>' +
                        '<p>Приложение не отвечает.</p>' +
                        '<p>1. Проверьте подключение к интернету</p>' +
                        '<p>2. Отключите блокировщики рекламы</p>' +
                        '<p>3. Если не грузится - используйте VPN</p>' +
                        '<button onclick="window.location.reload()" style="padding:10px 20px; margin-top:15px; cursor:pointer; background:white; border:none; border-radius:4px;">Обновить страницу</button>' +
                        '</div>';
                }
            }
        }, 8000);
    </script>
</body>

</html>