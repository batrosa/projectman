<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Prevent HTML caching - always fetch fresh version -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>ProjectMan</title>

    <!-- Preload critical CSS -->
    <link rel="preload" href="style.css?v=7.2" as="style">
    <link rel="stylesheet" href="style.css?v=7.2">
    <link rel="stylesheet" href="mobile-additions.css?v=7.9">

    <!-- Preconnect to external resources for faster loading -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.gstatic.com">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">

    <!-- Async load fonts - non-blocking -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"
        media="print" onload="this.media='all'">

    <!-- Async load icons - non-blocking -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        media="print" onload="this.media='all'">

    <!-- Inline critical CSS for loading screen -->
    <style>
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            opacity: 1;
            transition: opacity 0.4s ease-out;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-screen-content {
            text-align: center;
            padding: 2rem;
        }

        .loading-brand {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            font-size: 2rem;
            font-weight: 700;
            color: #6366f1;
            margin-bottom: 2.5rem;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .loading-brand i {
            font-size: 2.2rem;
        }

        .loading-spinner-container {
            margin-bottom: 2rem;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid rgba(99, 102, 241, 0.2);
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-tip {
            color: rgba(255, 255, 255, 0.7);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 0.95rem;
            max-width: 300px;
            margin: 0 auto;
            line-height: 1.5;
            min-height: 3em;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            text-align: left;
        }

        .loading-tip i {
            color: #6366f1;
            flex-shrink: 0;
            margin-top: 0.1rem;
        }

        /* Button spinner */
        .btn-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
    </style>

    <!-- Version checker - ОТКЛЮЧЕН временно для отладки -->
    <!-- <script src="version-check.js?v=1.9" defer></script> -->

    <!-- Scripts with defer for non-blocking loading -->
    <!-- Local Firebase Libraries for offline support and region independence -->
    <script src="libs/firebase-app.js" defer></script>
    <script src="libs/firebase-firestore.js" defer></script>
    <script src="libs/firebase-auth.js" defer></script>
    <!-- EmailJS загружается последним - он не критичен -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js" defer></script>
    <script src="script.js?v=7.1" defer></script>
</head>

<body>
    <!-- Loading Screen with Tips -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-screen-content">
            <div class="loading-brand">
                <i class="fa-solid fa-layer-group"></i>
                <span>ProjectMan</span>
            </div>
            <div class="loading-spinner-container">
                <div class="loading-spinner"></div>
            </div>
            <p class="loading-tip"><i class="fa-solid fa-lightbulb"></i> <span id="loading-tip">Загрузка...</span></p>
        </div>
    </div>

    <!-- Auth Overlay - Hidden by default, shown only if not logged in -->
    <div id="auth-overlay" class="login-overlay" style="display: none;">
        <!-- Registration/Login Screen -->
        <div id="auth-screen" class="login-card">
            <div class="brand" style="justify-content: center; margin-bottom: 1.5rem;">
                <i class="fa-solid fa-layer-group"></i> ProjectMan
            </div>
            <h2 id="auth-title">Вход в систему</h2>
            <p id="auth-subtitle" style="color: var(--text-secondary); margin-bottom: 2rem; text-align: center;">
                Войдите или зарегистрируйтесь
            </p>

            <!-- Login Form -->
            <form id="login-form" style="display: block; width: 100%;">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label for="login-password">Пароль</label>
                    <input type="password" id="login-password" required placeholder="Введите пароль">
                </div>
                <p id="login-error"
                    style="color: var(--danger); font-size: 0.85rem; margin-bottom: 1rem; display: none; text-align: left;">
                </p>
                <button type="submit" class="primary-btn"
                    style="width: 100%; justify-content: center; margin-bottom: 1rem;">Войти</button>
                <p style="text-align: center; font-size: 0.9rem; color: var(--text-secondary);">
                    Нет аккаунта? <a href="#" id="show-register"
                        style="color: var(--primary); text-decoration: none; font-weight: 500;">Зарегистрироваться</a>
                </p>
            </form>

            <!-- Registration Form -->
            <form id="register-form" style="display: none; width: 100%;">
                <div class="form-row" style="gap: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <label for="register-first-name">Имя</label>
                        <input type="text" id="register-first-name" required placeholder="Иван">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="register-last-name">Фамилия</label>
                        <input type="text" id="register-last-name" required placeholder="Иванов">
                    </div>
                </div>
                <div class="form-group">
                    <label for="register-email">Email</label>
                    <input type="email" id="register-email" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label for="register-password">Пароль</label>
                    <input type="password" id="register-password" required placeholder="Минимум 6 символов">
                </div>
                <div class="form-group">
                    <label for="register-password-confirm">Подтвердите пароль</label>
                    <input type="password" id="register-password-confirm" required placeholder="Повторите пароль">
                </div>
                <p id="register-error"
                    style="color: var(--danger); font-size: 0.85rem; margin-bottom: 1rem; display: none; text-align: left;">
                </p>
                <button type="submit" class="primary-btn"
                    style="width: 100%; justify-content: center; margin-bottom: 1rem;">Зарегистрироваться</button>
                <p style="text-align: center; font-size: 0.9rem; color: var(--text-secondary);">
                    Уже есть аккаунт? <a href="#" id="show-login"
                        style="color: var(--primary); text-decoration: none; font-weight: 500;">Войти</a>
                </p>
            </form>
        </div>

        <!-- Role Selection Screen (Removed) -->
        
        <!-- Admin Password Verification Modal -->
        <div id="admin-verify-screen" class="login-card" style="display: none;">
            <div class="brand" style="justify-content: center; margin-bottom: 2rem;">
                <i class="fa-solid fa-shield-halved"></i>
            </div>
            <h2>Подтверждение администратора</h2>
            <p style="color: var(--text-secondary); margin-bottom: 2rem; text-align: center;">Введите пароль
                администратора</p>

            <div class="form-group">
                <label for="admin-verify-password">Пароль администратора</label>
                <input type="password" id="admin-verify-password" placeholder="Введите пароль"
                    style="margin-bottom: 1rem;">
            </div>
            <p id="admin-verify-error"
                style="color: var(--danger); font-size: 0.8rem; margin-bottom: 1rem; display: none;">Неверный пароль</p>
            <div style="display: flex; gap: 1rem;">
                <button id="admin-verify-cancel" class="secondary-btn"
                    style="flex: 1; justify-content: center;">Отмена</button>
                <button id="admin-verify-submit" class="primary-btn"
                    style="flex: 1; justify-content: center;">Подтвердить</button>
            </div>
        </div>
    </div>

    <!-- Organization Selection Overlay -->
    <div id="org-overlay" class="login-overlay" style="display: none;">
        <!-- Choose: Create or Join -->
        <div id="org-choice-screen" class="login-card" style="max-width: 450px;">
            <div class="brand" style="justify-content: center; margin-bottom: 1.5rem;">
                <i class="fa-solid fa-layer-group"></i> ProjectMan
            </div>
            <h2 style="text-align: center;">Добро пожаловать!</h2>
            <p id="org-welcome-name" style="color: var(--text-secondary); margin-bottom: 2rem; text-align: center;"></p>
            
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <button id="org-create-btn" class="org-choice-btn">
                    <div class="org-choice-icon"><i class="fa-solid fa-building"></i></div>
                    <div class="org-choice-text">
                        <strong>Создать организацию</strong>
                        <span>Создайте рабочее пространство и пригласите команду</span>
                    </div>
                    <i class="fa-solid fa-chevron-right"></i>
                </button>

                <button id="org-join-btn" class="org-choice-btn">
                    <div class="org-choice-icon"><i class="fa-solid fa-link"></i></div>
                    <div class="org-choice-text">
                        <strong>У меня есть код</strong>
                        <span>Присоединитесь к существующей организации</span>
                    </div>
                    <i class="fa-solid fa-chevron-right"></i>
                </button>
            </div>
            
            <button id="org-logout-btn" class="secondary-btn" style="width: 100%; justify-content: center; margin-top: 2rem;">
                <i class="fa-solid fa-right-from-bracket"></i> Выйти из аккаунта
            </button>
        </div>
        
        <!-- Create Organization Screen -->
        <div id="org-create-screen" class="login-card" style="display: none; max-width: 450px;">
            <button id="org-create-back" class="back-btn">
                <i class="fa-solid fa-arrow-left"></i> Назад
            </button>
            <div class="brand" style="justify-content: center; margin-bottom: 1.5rem; margin-top: 1rem;">
                <i class="fa-solid fa-building"></i>
            </div>
            <h2 style="text-align: center;">Создание организации</h2>
            <p style="color: var(--text-secondary); margin-bottom: 2rem; text-align: center;">
                Вы станете владельцем и сможете приглашать сотрудников
            </p>
            
            <form id="org-create-form">
                <div class="form-group">
                    <label for="org-name">Название организации *</label>
                    <input type="text" id="org-name" required placeholder="ООО «Ромашка»" maxlength="100">
                </div>
                <p id="org-create-error" style="color: var(--danger); font-size: 0.85rem; margin-bottom: 1rem; display: none;"></p>
                <button type="submit" class="primary-btn" style="width: 100%; justify-content: center;">
                    <i class="fa-solid fa-plus"></i> Создать организацию
                </button>
            </form>
        </div>
        
        <!-- Join Organization Screen -->
        <div id="org-join-screen" class="login-card" style="display: none; max-width: 450px;">
            <button id="org-join-back" class="back-btn">
                <i class="fa-solid fa-arrow-left"></i> Назад
            </button>
            <div class="brand" style="justify-content: center; margin-bottom: 1.5rem; margin-top: 1rem;">
                <i class="fa-solid fa-link"></i>
            </div>
            <h2 style="text-align: center;">Присоединиться</h2>
            <p style="color: var(--text-secondary); margin-bottom: 2rem; text-align: center;">
                Введите код приглашения от администратора
            </p>
            
            <form id="org-join-form">
                <div class="form-group">
                    <label for="org-invite-code">Код приглашения *</label>
                    <input type="text" id="org-invite-code" required placeholder="ABC123" maxlength="20" style="text-transform: uppercase; letter-spacing: 2px; font-size: 1.2rem; text-align: center;">
                </div>
                <p id="org-join-error" style="color: var(--danger); font-size: 0.85rem; margin-bottom: 1rem; display: none;"></p>
                <div id="org-join-preview" style="display: none; background: rgba(99, 102, 241, 0.1); border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                    <p style="margin: 0; font-weight: 600;" id="org-join-name"></p>
                    <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary);" id="org-join-members"></p>
                </div>
                <button type="submit" class="primary-btn" id="org-join-submit-btn" style="width: 100%; justify-content: center;">
                    <i class="fa-solid fa-right-to-bracket"></i> Присоединиться
                </button>
            </form>
        </div>
    </div>

    <div class="app-container" id="app-container" style="display: none;">
        <aside class="sidebar">
            <!-- Organization Header -->
            <div id="org-header" class="org-header" style="display: none;">
                <button id="org-menu-btn" class="org-menu-btn">
                    <div class="org-info">
                        <i class="fa-solid fa-building"></i>
                        <span id="org-name-display">Организация</span>
                    </div>
                    <i class="fa-solid fa-chevron-down org-chevron"></i>
                </button>
                
                <!-- Organization Dropdown Menu -->
                <div id="org-dropdown" class="org-dropdown" style="display: none;">
                    <div class="org-dropdown-header">
                        <p class="org-dropdown-name" id="org-dropdown-name"></p>
                        <p class="org-dropdown-role" id="org-dropdown-role"></p>
                    </div>
                    <div class="org-dropdown-divider"></div>
                    <div class="org-dropdown-section">
                        <p class="org-dropdown-label">Код приглашения</p>
                        <div class="org-invite-code-row">
                            <code id="org-invite-code-display">------</code>
                            <button id="org-copy-code" class="org-copy-btn" title="Копировать">
                                <i class="fa-solid fa-copy"></i>
                            </button>
                        </div>
                        <button id="org-share-btn" class="secondary-btn org-share-btn">
                            <i class="fa-solid fa-share-nodes"></i> Поделиться ссылкой
                        </button>
                        <button id="org-regenerate-code" class="secondary-btn org-regenerate-btn">
                            <i class="fa-solid fa-arrows-rotate"></i> Сменить код
                        </button>
                    </div>
                    <div class="org-dropdown-divider"></div>
                    <button id="org-leave-btn" class="org-dropdown-item org-leave">
                        <i class="fa-solid fa-right-from-bracket"></i> Покинуть организацию
                    </button>
                    <button id="org-delete-btn" class="org-dropdown-item org-delete" style="display: none; color: var(--danger);">
                        <i class="fa-solid fa-trash"></i> Удалить организацию
                    </button>
                </div>
            </div>
            
            <div class="brand" id="brand-logo">
                <i class="fa-solid fa-layer-group"></i> ProjectMan
            </div>

            <div class="projects-header">
                <h3>ПРОЕКТЫ</h3>
                <button id="add-project-btn" class="icon-btn" title="Создать проект">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <ul id="project-list" class="project-list">
                <!-- Projects will be injected here -->
            </ul>

            <div class="sidebar-footer"
                style="margin-top: auto; padding-top: 1rem; display: flex; flex-direction: column; gap: 0.5rem;">
                <button id="my-tasks-btn" class="my-tasks-btn" style="width: 100%; justify-content: center;">
                    <i class="fa-solid fa-list-check"></i> <span>Мои задачи</span>
                    <span id="my-tasks-count" class="my-tasks-count" style="display: none;">0</span>
                </button>
                <button id="admin-panel-btn" class="secondary-btn"
                    style="width: 100%; justify-content: center; display: none;">
                    <i class="fa-solid fa-user-shield"></i> <span>Админ панель</span>
                </button>
                <button id="theme-toggle" class="secondary-btn" style="width: 100%; justify-content: center;">
                    <i class="fa-regular fa-sun"></i> <span>Светлая тема</span>
                </button>
                <button id="logout-btn" class="danger-btn"
                    style="width: 100%; justify-content: center; background: rgba(239, 68, 68, 0.05);">
                    <i class="fa-solid fa-right-from-bracket"></i> <span>Выйти</span>
                </button>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <button id="mobile-menu-btn" class="icon-btn" style="margin-right: 1rem; font-size: 1.2rem;">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <div class="project-info" id="active-project-info">
                    <h1 id="project-title">Выберите проект</h1>
                    <p id="project-desc">или создайте новый, чтобы начать работу</p>
                </div>
                <div class="actions">
                    <button id="help-btn" class="secondary-btn" title="Помощь">
                        <i class="fa-solid fa-circle-question"></i>
                    </button>
                    <button id="add-task-btn" class="primary-btn" disabled>
                        <i class="fa-solid fa-plus"></i> Новая задача
                    </button>
                    <button id="delete-project-btn" class="danger-btn" style="display: none;">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </header>

            <div class="board-container" id="board-container">
                <!-- Kanban Columns -->
                <!-- Kanban Columns -->

                <div class="column" data-status="in-progress">
                    <div class="column-header">
                        <span class="status-indicator in-progress"></span>
                        <h2>В процессе</h2>
                        <span class="count" id="count-in-progress">0</span>
                    </div>
                    <div class="task-list" id="list-in-progress">
                        <!-- Tasks -->
                    </div>
                </div>

                <div class="column" data-status="done">
                    <div class="column-header">
                        <span class="status-indicator done"></span>
                        <h2>Готово</h2>
                        <span class="count" id="count-done">0</span>
                    </div>
                    <div class="task-list" id="list-done">
                        <!-- Tasks -->
                    </div>
                </div>
            </div>

            <div id="empty-state" class="empty-state">
                <i class="fa-solid fa-clipboard-list"></i>
                <p>Выберите проект слева, чтобы увидеть задачи</p>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="project-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Новый проект</h2>
                <button class="close-modal"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <form id="project-form">
                <div class="form-group">
                    <label for="p-name">Название</label>
                    <input type="text" id="p-name" required placeholder="">
                </div>
                <div class="form-group">
                    <label for="p-desc">Описание деятельности</label>
                    <textarea id="p-desc" rows="3" placeholder="Краткое описание..."></textarea>
                </div>
                <div class="form-group">
                    <label class="checkbox-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="p-has-deadline" style="width: auto;">
                        <span>Установить срок проекта</span>
                    </label>
                </div>
                <div class="form-group" id="p-deadline-group" style="display: none;">
                    <label for="p-deadline">Срок выполнения</label>
                    <input type="date" id="p-deadline">
                </div>
                <div class="modal-footer">
                    <button type="button" class="secondary-btn close-modal">Отмена</button>
                    <button type="submit" class="primary-btn">Создать</button>
                </div>
            </form>
        </div>
    </div>

    <div id="task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Новая задача</h2>
                <button class="close-modal"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="task-form-body">
                <form id="task-form">
                    <div class="form-group">
                        <label for="t-title">Задача</label>
                        <input type="text" id="t-title" required placeholder="Что нужно сделать?">
                    </div>

                    <div class="form-group">
                        <label for="t-description">Комментарий / Описание</label>
                        <textarea id="t-description" rows="3" placeholder="Подробности задачи..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Ответственные</label>
                            <div id="t-assignee-container" class="assignee-picker">
                                <div id="selected-assignees" class="selected-assignees">
                                    <!-- Selected assignee chips will appear here -->
                                </div>
                                <div class="assignee-search-wrapper">
                                    <input type="text" id="assignee-search" class="assignee-search-input" placeholder="Введите имя..." autocomplete="off">
                                    <div id="assignee-dropdown" class="assignee-dropdown">
                                        <!-- Search results will appear here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="t-deadline">Срок</label>
                            <input type="date" id="t-deadline" required>
                        </div>
                    </div>

                    <!-- File Attachments Section -->
                    <div class="form-group">
                        <label><i class="fa-solid fa-paperclip"></i> Прикрепленные файлы (макс. 2)</label>
                        <div id="attachments-container" class="attachments-container">
                            <div id="attachments-list" class="attachments-list">
                                <!-- Attached files will appear here -->
                            </div>
                            <button type="button" id="add-attachment-btn" class="add-attachment-btn">
                                <i class="fa-solid fa-plus"></i> Прикрепить файл
                            </button>
                            <input type="file" id="file-input" style="display: none;" 
                                   accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.zip,.rar">
                            <p class="attachment-hint">PDF, Word, Excel, изображения, архивы. Макс. 10 MB</p>
                        </div>
                    </div>

                    <!-- Status hidden, defaults to in-progress -->
                    <input type="hidden" id="t-status" value="in-progress">
                    <input type="hidden" id="t-id">
                </form>
            </div>
            <div class="task-modal-footer">
                <button type="button" class="secondary-btn close-modal">Отмена</button>
                <button type="submit" form="task-form" class="primary-btn">Создать</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal">
        <div class="modal-content help-modal-content">
            <div class="modal-header">
                <h2><i class="fa-solid fa-circle-question"></i> Помощь</h2>
                <button class="close-modal"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="help-content">
                <div class="help-section">
                    <h3><i class="fa-solid fa-rocket"></i> О приложении</h3>
                    <p>ProjectMan — система управления задачами с двойным контролем выполнения. Приложение позволяет создавать проекты, назначать задачи сотрудникам и отслеживать их выполнение в реальном времени.</p>
                </div>

                <div class="help-section">
                    <h3><i class="fa-solid fa-lock"></i> Вход в приложение</h3>
                    <p>Для доступа к приложению требуется:</p>
                    <ul>
                        <li><strong>PIN-код:</strong> 4-значный код для входа в приложение.</li>
                        <li><strong>Авторизация:</strong> Вход через email и пароль или регистрация нового аккаунта.</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3><i class="fa-solid fa-users"></i> Роли пользователей</h3>
                    <p><strong>Администратор:</strong></p>
                    <ul>
                        <li>Создание и удаление проектов</li>
                        <li>Создание, редактирование и удаление задач</li>
                        <li>Назначение ответственных сотрудников</li>
                        <li>Управление пользователями (панель администратора)</li>
                        <li>Финальное подтверждение выполненных задач</li>
                    </ul>
                    <p><strong>Сотрудник:</strong></p>
                    <ul>
                        <li>Просмотр доступных проектов и задач</li>
                        <li>Принятие задач в работу</li>
                        <li>Отметка о выполнении с прикреплением подтверждения</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3><i class="fa-solid fa-folder-open"></i> Проекты</h3>
                    <p>Проекты — это категории для группировки задач. Выбирайте проект в боковом меню слева (на ПК) или через кнопку <i class="fa-solid fa-bars"></i> (на мобильном).</p>
                    <ul>
                        <li>Администратор может создавать неограниченное количество проектов</li>
                        <li>Доступ сотрудников к проектам настраивается в панели администратора</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3><i class="fa-solid fa-clipboard-list"></i> Создание задачи</h3>
                    <p>При создании задачи указываются:</p>
                    <ul>
                        <li><strong>Название:</strong> Краткое описание задачи</li>
                        <li><strong>Описание:</strong> Подробности и комментарии</li>
                        <li><strong>Ответственные:</strong> Поиск сотрудников по имени или фамилии</li>
                        <li><strong>Срок:</strong> Дата выполнения задачи</li>
                        <li><strong>Файлы:</strong> До 2 файлов (макс. 10 МБ каждый)</li>
                    </ul>
                    <div class="help-note">
                        <i class="fa-solid fa-lightbulb"></i> При назначении задачи сотруднику автоматически отправляется email-уведомление.
                    </div>
                </div>

                <div class="help-section">
                    <h3><i class="fa-solid fa-list-check"></i> Статусы задач</h3>
                    <ul style="list-style: none; padding-left: 0;">
                        <li style="margin-bottom: 0.75rem;">
                            <span style="color: #e67e22; font-weight: 600;"><i class="fa-solid fa-circle-exclamation"></i> Задача поставлена</span><br>
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">Новая задача, ожидает принятия сотрудником</span>
                        </li>
                        <li style="margin-bottom: 0.75rem;">
                            <span style="color: #f39c12; font-weight: 600;"><i class="fa-solid fa-person-digging"></i> В работе</span><br>
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">Сотрудник принял задачу и работает над ней</span>
                        </li>
                        <li style="margin-bottom: 0.75rem;">
                            <span style="color: #2ecc71; font-weight: 600;"><i class="fa-solid fa-check"></i> Задача завершена</span><br>
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">Сотрудник выполнил работу, ожидает проверки</span>
                        </li>
                        <li>
                            <span style="color: #2ecc71; font-weight: 600;"><i class="fa-solid fa-check-double"></i> Готово (Архив)</span><br>
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">Администратор подтвердил выполнение</span>
                        </li>
                    </ul>
                    <div class="help-note">
                        <i class="fa-solid fa-hand-pointer"></i> Нажмите на статус задачи, чтобы изменить его.
                    </div>
                </div>

                <div class="help-section">
                    <h3><i class="fa-solid fa-clipboard-check"></i> Подтверждение выполнения</h3>
                    <p>При завершении задачи сотрудник должен:</p>
                    <ul>
                        <li>Написать комментарий о выполненной работе</li>
                        <li>Прикрепить файл-подтверждение (фото, документ)</li>
                    </ul>
                    <p>После этого администратор проверяет работу и переводит задачу в архив.</p>
                </div>

                <div class="help-section">
                    <h3><i class="fa-solid fa-tasks"></i> Мои задачи</h3>
                    <p>Кнопка «Мои задачи» в боковом меню показывает все задачи, где вы назначены ответственным. Красный бейдж отображает количество активных задач и обновляется в реальном времени.</p>
                </div>

                <div class="help-section">
                    <h3><i class="fa-solid fa-info-circle"></i> Информация о задаче</h3>
                    <p>Нажмите кнопку <i class="fa-solid fa-info"></i> на карточке задачи, чтобы увидеть:</p>
                    <ul>
                        <li>Полное описание задачи</li>
                        <li>Список ответственных</li>
                        <li>Историю изменений статуса</li>
                        <li>Комментарий и файл подтверждения (если есть)</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3><i class="fa-solid fa-palette"></i> Оформление</h3>
                    <p>Приложение поддерживает светлую и тёмную тему. Переключение — кнопка <i class="fa-solid fa-moon"></i> / <i class="fa-solid fa-sun"></i> в боковом меню.</p>
                </div>

                <div class="help-section">
                    <h3><i class="fa-solid fa-mobile-screen"></i> Мобильная версия</h3>
                    <p>Приложение полностью адаптировано для смартфонов:</p>
                    <ul>
                        <li><strong>Меню:</strong> Кнопка <i class="fa-solid fa-bars"></i> открывает боковое меню</li>
                        <li><strong>Задачи:</strong> Вертикальный скролл списка задач</li>
                        <li><strong>Управление:</strong> Увеличенные кнопки для удобного нажатия</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- File Preview Modal -->
    <div id="file-preview-modal" class="modal">
        <div class="modal-content file-preview-content">
            <div class="modal-header">
                <h2><i class="fa-solid fa-file"></i> <span id="preview-file-name">Файл</span></h2>
                <div style="display: flex; gap: 0.5rem;">
                    <a id="preview-download-btn" href="#" download class="secondary-btn" style="padding: 0.5rem 1rem;">
                        <i class="fa-solid fa-download"></i>
                    </a>
                    <button class="close-modal"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>
            <div id="file-preview-container" class="file-preview-container">
                <!-- Preview content will be injected here -->
                <div class="preview-loading">
                    <div class="spinner"></div>
                    <p>Загрузка файла...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Files List Modal (for task card) -->
    <div id="files-list-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fa-solid fa-paperclip"></i> Прикрепленные файлы</h2>
                <button class="close-modal"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="files-modal-list" class="files-modal-list">
                <!-- Files will be listed here -->
            </div>
        </div>
    </div>

    <!-- Completion Proof Modal (when executor completes task) -->
    <div id="completion-proof-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fa-solid fa-clipboard-check"></i> Подтверждение выполнения</h2>
                <button class="close-modal"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <form id="completion-proof-form">
                <div style="padding: 1.5rem;">
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                        Опишите выполненную работу и прикрепите подтверждение (фото, документ)
                    </p>
                    <div class="form-group">
                        <label for="completion-comment">Комментарий о выполнении <span style="color: var(--danger);">*</span></label>
                        <textarea id="completion-comment" rows="4" required placeholder="Опишите что было сделано..."></textarea>
                    </div>
                    <div class="form-group">
                        <label><i class="fa-solid fa-paperclip"></i> Файл-подтверждение <span style="color: var(--danger);">*</span></label>
                        <div id="completion-attachments-container" class="attachments-container">
                            <div id="completion-attachments-list" class="attachments-list">
                                <!-- Attached file will appear here -->
                            </div>
                            <button type="button" id="add-completion-file-btn" class="add-attachment-btn">
                                <i class="fa-solid fa-camera"></i> Прикрепить файл / фото
                            </button>
                            <input type="file" id="completion-file-input" style="display: none;" 
                                   accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.zip,.rar,.heic">
                            <p class="attachment-hint">Фото, PDF, документы. Макс. 10 MB</p>
                        </div>
                    </div>
                    <input type="hidden" id="completion-task-id">
                </div>
                <div class="modal-footer">
                    <button type="button" class="secondary-btn close-modal" id="cancel-completion-btn">Отмена</button>
                    <button type="submit" class="primary-btn" id="submit-completion-btn">
                        <i class="fa-solid fa-check"></i> Завершить задачу
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Task Details Modal (history and completion info) -->
    <div id="task-details-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2><i class="fa-solid fa-circle-info"></i> Информация о задаче</h2>
                <button class="close-modal"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="task-details-content" style="padding: 1.5rem;">
                <!-- Task details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- My Tasks Modal -->
    <div id="my-tasks-modal" class="modal">
        <div class="modal-content my-tasks-modal-content">
            <div class="modal-header">
                <h2><i class="fa-solid fa-list-check"></i> Мои задачи</h2>
                <button class="close-modal"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="my-tasks-content">
                <div id="my-tasks-list" class="my-tasks-list">
                    <!-- User's tasks will be loaded here -->
                    <div class="my-tasks-empty">
                        <i class="fa-solid fa-clipboard-check"></i>
                        <p>У вас нет назначенных задач</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="admin-panel-modal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2><i class="fa-solid fa-user-shield"></i> Админ панель</h2>
                <button class="close-modal"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="admin-panel-content" style="padding: 1.5rem;">
                <div class="admin-tabs">
                    <button class="admin-tab active" data-tab="users">
                        <i class="fa-solid fa-users"></i> Пользователи
                    </button>
                    <button class="admin-tab" data-tab="access">
                        <i class="fa-solid fa-key"></i> Доступ к проектам
                    </button>
                </div>

                <!-- Users Tab -->
                <div id="admin-users-tab" class="admin-tab-content active">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0;">Зарегистрированные пользователи</h3>
                        <span id="users-count" style="color: var(--text-secondary); font-size: 0.9rem;">0
                            пользователей</span>
                    </div>
                    <div id="users-list" class="users-list">
                        <!-- Users will be loaded here -->
                    </div>
                </div>

                <!-- Project Access Tab -->
                <div id="admin-access-tab" class="admin-tab-content">
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="margin-bottom: 0.5rem;">Управление доступом к проектам</h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">
                            Выберите пользователя и настройте, какие проекты он может видеть
                        </p>
                    </div>

                    <div class="form-group">
                        <label for="access-user-select">Пользователь</label>
                        <select id="access-user-select"
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary); color: var(--text); font-size: 0.95rem;">
                            <option value="">Выберите пользователя...</option>
                        </select>
                    </div>

                    <div id="user-access-info" style="display: none;">
                        <div
                            style="background: var(--bg-secondary); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div class="avatar" style="width: 48px; height: 48px; font-size: 1.2rem;"
                                    id="selected-user-avatar">AB</div>
                                <div>
                                    <h4 id="selected-user-name" style="margin: 0;">Имя Фамилия</h4>
                                    <p id="selected-user-email"
                                        style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">
                                        email@example.com</p>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                <input type="checkbox" id="allow-all-projects" style="width: auto;">
                                <span>Доступ ко всем проектам</span>
                            </label>
                        </div>

                        <div id="project-selection" style="display: block;">
                            <label style="margin-bottom: 0.75rem; display: block; font-weight: 500;">Доступные
                                проекты:</label>
                            <div id="projects-checkboxes" class="projects-checkboxes">
                                <!-- Project checkboxes will be loaded here -->
                            </div>
                        </div>

                        <button id="save-access-btn" class="primary-btn"
                            style="width: 100%; justify-content: center; margin-top: 1.5rem;">
                            <i class="fa-solid fa-save"></i> Сохранить настройки доступа
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading overlay removed - fast load -->
</body>

</html>